<script src="expression-compiler.js"></script>
<script>
var l = function(m,d){ document.write((d?'':"<pre>") + m + (d?'':"</pre>")); };
var notify = function(msg, d) { console.log(msg); l(msg, d); };
var assertEqual = function(ex, got, m) {
    if (ex === got) notify("Good! " + ex);
    else notify('FAIL: ' + ex + ' !== ' + got + (m ? ': ' + m : ''));
};

var standard_context = {
    "r": 0.3,
    "r'": 0.4,
    "r|": 0.5
};

var testLexTypes = function(expression, expected) {
    var tokens = EXC.lex(expression);
    for (t=0; t< Math.max(expected.length, tokens.length); t++) {
        assertEqual(expected[t], tokens[t][0]);
    }
};

var testLexValues = function(exp, expected) {
    tokens = EXC.lex(exp);
    assertEqual(exp, expected);
};

var testExpression = function(exp, expected, ctx) {
    ctx = (typeof ctx === "undefined") ? standard_context : ctx;
    var compiled = new EXC(exp);
    var evaluated = compiled.solve(ctx);
    assertEqual(compiled());
};

(function() {
    try {
        EXC.lex_machine.get_next("!");
    } catch (e) {
        assertEqual(e, "invalid state machine exit");
    }
    assertEqual(EXC.lex_machine.get_next(" ").name, "whitespace");
    assertEqual(EXC.lex_machine.get_next("0").name, "literal");
    assertEqual(EXC.lex_machine.get_next("0").get_next(".").name, "literal");
    assertEqual(EXC.lex_machine.get_next(".").get_next("1").name, "literal");
    assertEqual(EXC.lex_machine.get_next("1").get_next("1").name, "literal");
    assertEqual(EXC.lex_machine.get_next(".").name, null);
    assertEqual(EXC.lex_machine.get_next("r").name, "name");
    assertEqual(EXC.lex_machine.get_next("r").get_next("'").name, "name");
    assertEqual(EXC.lex_machine.get_next("(").name, "o_paren");
    assertEqual(EXC.lex_machine.get_next(")").name, "c_paren");
    assertEqual(EXC.lex_machine.get_next("^").name, "power");
    assertEqual(EXC.lex_machine.get_next("*").name, "multiply");
    assertEqual(EXC.lex_machine.get_next("/").name, "divide");
    assertEqual(EXC.lex_machine.get_next("+").name, "plus");
    assertEqual(EXC.lex_machine.get_next("-").name, "minus");
    assertEqual(EXC.lex_machine.get_next("<").name, "less");
    assertEqual(EXC.lex_machine.get_next(">").name, "greater");
})();

assertEqual(EXC.lex(" ")[0].name, "whitespace");
assertEqual(EXC.lex("0")[0].name, "literal");
assertEqual(EXC.lex("+")[0].name, "plus");

assertEqual(EXC.compile("0")(), 0);
assertEqual(EXC.compile("1")(), 1);
assertEqual(EXC.compile("-1")(), -1);
assertEqual(EXC.compile("1-1")(), 0);
assertEqual(EXC.compile("0-1")(), -1);
assertEqual(EXC.compile("0+1")(), 1);
assertEqual(EXC.compile("1+1")(), 2);
assertEqual(EXC.compile("-1+1")(), 0);
assertEqual(EXC.compile("1*1")(), 1);
assertEqual(EXC.compile("1*0")(), 0);
assertEqual(EXC.compile("2*1")(), 2);
assertEqual(EXC.compile("1/2")(), 0.5);
assertEqual(EXC.compile("1/0")(), Infinity);
assertEqual(+EXC.compile("1 > 0")(), 1);
assertEqual(+EXC.compile("1 < 0")(), 0);
assertEqual(EXC.compile("r")({r: 1}), 1);

assertEqual(EXC.mark("1"), '<span class="expression-literal">1</span>');
assertEqual(EXC.mark("! 1 r"), '<span class="expression-invalid">! 1 r</span>');

assertEqual(EXC.compile("(1)")(), 1);
assertEqual(EXC.compile("(1+1)")(), 2);
assertEqual(EXC.compile("(1+1)*2")(), 4);

</script>
